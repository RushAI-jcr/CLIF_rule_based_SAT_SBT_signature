# Site Instructions: SAT/SBT EHR Phenotyping Study

## Overview

Each CLIF site runs the phenotyping pipeline locally on their own data, then sends the outputs to the coordinating center for aggregation.

**You run scripts 00-02. The coordinating center runs 03-07.**

## Prerequisites

1. **Python 3.9+** with packages: `pip install -r requirements.txt`
2. **CLIF 2.1 tables** (parquet or CSV) at a local path
3. **Config file**: copy `config/config_template.json` to `config/config.json` and fill in:

```json
{
    "site_name": "YOUR_SITE_CODE",
    "tables_path": "/path/to/your/clif/tables/",
    "file_type": "parquet",
    "your_site_timezone": "US/Central"
}
```

## Execution Order

Run from the repo root:

```bash
bash scripts/run_site.sh
```

This executes in order:

| Step | Script | What it does | Key output |
|------|--------|-------------|------------|
| 1 | `00_cohort_id.py` | Builds study cohort from CLIF tables | `output/intermediate/study_cohort.parquet` |
| 2 | `01_SAT_standard.py` | SAT eligibility + delivery phenotyping | `output/intermediate/final_df_SAT.csv` |
| 3 | `02_SBT_Standard.py` | SBT eligibility + delivery phenotyping | `output/intermediate/final_df_SBT.csv` |
| 4 | `02_SBT_*.py` | SBT sensitivity variants | Variant-specific outputs |

Or run each step individually:
```bash
cd code/
python 00_cohort_id.py
python 01_SAT_standard.py
python 02_SBT_Standard.py
```

**Interactive notebooks** (`.ipynb`) are also available if you prefer Jupyter.

## Files to Send to Coordinating Center

After the pipeline completes, send these files via your institution's approved secure transfer method:

### Required

| File | Path |
|------|------|
| Study cohort | `output/intermediate/study_cohort.parquet` |
| SAT day-level | `output/intermediate/final_df_SAT.csv` |
| SBT day-level | `output/intermediate/final_df_SBT.csv` |
| SAT concordance | `output/final/{SITE}/SAT_standard/*.csv` |
| SBT concordance | `output/final/{SITE}/SBT_standard/*.csv` |

### Optional (if produced)

| File | Path |
|------|------|
| SBT variants | `output/final/{SITE}/SBT_hemodynamic/*.csv` |
| SBT variants | `output/final/{SITE}/SBT_respiratory/*.csv` |
| SBT variants | `output/final/{SITE}/SBT_both/*.csv` |

## Where to Place Files at Coordinating Center

The coordinating center should place received site outputs as:

```
output/
  intermediate/
    study_cohort.parquet       <- merged from all sites (or per-site concatenated)
    final_df_SAT.csv           <- merged from all sites
    final_df_SBT.csv           <- merged from all sites
  final/
    SITE_A/
      SAT_standard/            <- site A's SAT outputs
      SBT_standard/            <- site A's SBT outputs
    SITE_B/
      SAT_standard/
      SBT_standard/
    ...
    pooled/                    <- generated by aggregation scripts
```

## Troubleshooting

- **Config not found**: Ensure `config/config.json` exists (not just the template)
- **Missing CLIF tables**: Verify `tables_path` points to a directory containing your CLIF 2.1 tables
- **Import errors**: Run `pip install -r requirements.txt` to install all dependencies
- **Timezone issues**: Set `your_site_timezone` to your local IANA timezone (e.g., `US/Eastern`, `US/Pacific`, `America/Chicago`)

## Contact

Questions about the pipeline: [coordinating center contact]
Questions about CLIF 2.1: https://clif-icu.com
